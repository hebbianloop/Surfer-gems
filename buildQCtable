#!/bin/bash
# ------------------------------------------------------------------------------------------------------------
# Default Arguments
qcdir="/Volumes/Archive.ADS/ADS/data/ads.subjects.trashcan.qc"
qcdatatable="/Volumes/Archive.ADS/ADS/data/ads.subjects.trashcan/w1-qc"
## Enable advanced pattern matching
shopt -s extglob
# ------------------------------------------------------------------------------------------------------------
# Help Function
show_help() {
    cat <<EOF

    Usage ${0##*/} [-h|--help] [-i|--indir PATH] [-o|--outfile FILE] 
    
    Generates concatenated table of FreeSurfer QC statistics generated by FSQC-summary
    or by FSQC-check.

    Options :: 

    -h  --help           displays help
    -i  --indir          path to QC directory
    -o  --oname     	 filename for output data

    Example :: 

    Concatenate FreeSurfer QC data across subjects

    	${0##*/} -i $qcdir -o $qcdatatable

    Default Behavior ::

    	INPUT DIR 		   --     $qcdir
    	OUTPUT DATA        --     $qcdatatable

    !! Important

    	* Filename for output data as specified by -o flag will be written as a tab
    	  delimited .txt file by default.  The file is then converted to .xlsx if 
    	  Gnumeric is installed on the machine.

EOF
}
# ------------------------------------------------------------------------------------------------------------
# Option Parsing
while :; do
    case $1 in
        -h|--help)
        show_help
        exit 
        ;;
        -i|--indir)
            if [ -n "$2" ]; then
                qcdir=$2
                shift
            else
                echo "ERROR:  -i --indir requires a non-empty option argument.\n" >&2
                exit 
            fi
		;;
        -o|--oname)
            if [ -n "$2" ]; then
                qcdatatable=$2
                shift
            else
                echo "ERROR:  -o --outfile requires a non-empty option argument.\n" >&2
                exit 
            fi
		;;		
        *)
            break
    esac
    shift
done
# ------------------------------------------------------------------------------------------------------------
# Initialize Data Table
touch "$qcdatatable.txt"
# Build tab delimited header (ID lhCNR rhCNR lhEN rhEN TalCorr)
header= printf "SubjectID\tlhCNR\trhCNR\tlhEN\trhEN\tTalCorr\n" > "$qcdatatable.txt"
echo $header
# ------------------------------------------------------------------------------------------------------------
# Loop across subjects and extract information
cd $qcdir
subs=$(ls -d !(*.*))
for sub in $subs; do
	# clean str
	str=''
	if [ ! -f $qcdir/$sub/recon-all-fail.log ]; then
		# build first part of string (ID CNR)
		str=$(cat $qcdir/$sub/CNR.log | grep "[?h] CNR" | cut -d ' ' -f4 | xargs printf "$sub\t%s\t%s\t")
		# build second part of string (EN)
		str="$str$(cat "$qcdir/$sub/euler-characteristic.log" | grep  -o '[lr]heno = .*' | perl -lne 'print $1 if /=\s*(.*)/' | awk '{print $1,$4}' | tr -d ',' | xargs printf "\t%s\t%s\t")"
		# build last part of string (TalCorr)
		str="$str$(cat $qcdir/$sub/talairach-spatial-correlation.log | cut -d ':' -f2 | awk '{print $NF}' | xargs printf "%s\n")"
	else
		str=$(printf "$sub\t\t\t\t\t\n")
	fi
	echo $str >> "$qcdatatable.txt"
	echo $str
done
# ------------------------------------------------------------------------------------------------------------
# Convert to xlsx with Gnumeric
if [ ! -z $(which gnumeric) ]; 
	echo -e "\n Converting to Microsoft 2010 .xlsx format\n"
	ssconvert "$qcdatatable.txt" "$qcdatatable.xlsx"
else
	echo -e "\n‼️  Gnumeric ssconvert tool not found.\n\tCannot convert $qcdatatable.txt to $qcdatatable.xlsx.\n"
fi